<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="description" content="An Open Source Project for secure and robust containerized application management for constrained devices.">
	<meta property="og:title" content="Open Horizon" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://localhost:4000///docs/developing/service_operators.html" />
<meta property="og:image" content="http://localhost:4000//img/hero-dark.jpg">

	

	<meta name="citation_title" content="Project Pages - An Integrated Scientific Blogging Template">



	

	<link rel='shortcut icon' type='image/png' href='/img/favicon.png' />

    <title>Open Horizon</title>

    <link rel="canonical" href="http://localhost:4000/docs/developing/service_operators.html">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="http://localhost:4000/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="http://localhost:4000/css/clean-blog.css">

	<!-- Adjust Colors -->
    <link rel="stylesheet" href="http://localhost:4000/css/colorscheme.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="http://localhost:4000/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/css/normalize.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/cayman.css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
	<!-- Math Jax -->
	<script type="text/x-mathjax-config">
	MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
	</script>
	<script type="text/javascript"
	src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
	</script>
	<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
		TeX: { equationNumbers: { autoNumber: "AMS" } }
	});
	</script>

	<!--<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js" type="text/javascript"></script>-->

    <!-- jQuery -->
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<!-- Custom Theme JavaScript -->
	<script src="http://localhost:4000/js/clean-blog.min.js "></script>

    <!-- Clipboard.js -->
    <script src="http://localhost:4000/js/clipboard.min.js " ></script>

    <!-- CDN Hosted Clipboard.js -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script> -->


	

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Open Horizon</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>

                <li>
                    <a href="/quick-start">Quick Start</a>
                </li>

                <li>
                    <a href="/docs/">Docs</a>
                </li>

                <!-- <li>
                    <a href="/blog">Blog</a>
                </li> -->

                <li>
                    <a href="/docs/getting_started/faq.html">FAQ</a>
                </li>


            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Page Header -->
<header class="intro-header" style="background-image: url('/img/hero-dark.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="site-heading" style="padding: 75px 0">
					
                    
                    

                    <h1 style="font-size:4.0em">Open Horizon</h1>
                    <hr class="small">

                    <span class="subheading">An Open Source Project for secure and robust containerized application management for constrained devices.</span>
                    

                </div>
            </div>
        </div>
    </div>
</header>

<div class="container">
	<div class="row">
      <div class="col-lg-12 col-md-12">
			
<h1 id="kubernetes_operator">Developing a Kubernetes operator</h1>

<p>In general, developing a service to run in an edge cluster is similar to developing an edge service that runs on an edge device. The edge service is developed using <a href="/docs/developing/best_practices.html">Edge-native development best practices</a> development, and it is packaged in a container. The difference is in how the edge service is deployed.</p>

<p>To deploy a containerized edge service to an edge cluster, a developer must first build a Kubernetes operator that deploys the containerized edge service in a Kubernetes cluster. After the operator is written and tested, the developer creates and publishes the operator as an Open Horizon (Open Horizon) service. This process enables an Open Horizon administrator to deploy the operator service as would be done for any Open Horizon service, with policy or patterns. There is no need to create an Open Horizon service definition for the edge service. When the Open Horizon administrator deploys the operator service, the operator deploys the edge service.</p>

<p>Several sources of information are available when you write a Kubernetes operator. First, read <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/">Kubernetes Concepts - Operator pattern <img src="../images/icons/launch-glyph.svg" alt="Opens in a new tab" title="Opens in a new tab" /></a>. This site is a good resource to learn about operators. After you are familiar with the operator concepts, writing an operator is accomplished by using the <a href="https://operatorframework.io/">Operator Framework <img src="../images/icons/launch-glyph.svg" alt="Opens in a new tab" title="Opens in a new tab" /></a>. This web site provides more details about what an operator is and gives a walk-through for creating a simple operator, using the operator Software Development Kit (SDK).</p>

<h2 id="considerations-when-developing-an-operator-for-open-horizon">Considerations when developing an operator for Open Horizon</h2>

<p>It is a best practice to make liberal use of the operator’s status capability because Open Horizon reports whatever status the operator creates into the Open Horizon management hub. When writing an operator, the operator-framework generates a Kubernetes Custom Resource Definition (CRD) for the operator. Every operator CRD has a status object that should be populated with important status information about the state of the operator and the edge service it is deploying. This is not done automatically by Kubernetes; it needs to be written into the implementation of the operator by the operator developer. The Open Horizon agent in an edge cluster periodically gathers operator status and reports it to the management hub.</p>

<p>If wanted, the operator can attach the service-specific Open Horizon environment variables to any services that it starts. When the operator is started, the Open Horizon agent creates a kubernetes configmap called <code class="language-plaintext highlighter-rouge">hzn-env-vars</code> that contains the service-specific environment variables. The operator can optionally attach that config map to any deployments that it creates, which enables services that it starts to recognize the same service-specific environment variables. These are the same environment variables that are injected into services that run on edge devices. The only exception are the ESS* environment variables, because the Model Management System (MMS) is not yet supported for edge cluster services.</p>

<p>If wanted, operators that are deployed by Open Horizon can be deployed into a namespace other than the default namespace. This is accomplished by the operator developer modifying the operator yaml files to point to the namespace. There are two ways to accomplish this:</p>

<ul>
  <li>Modify the operator’s Deployment definition (usually called <strong>./deploy/operator.yaml</strong>) to specify a namespace</li>
</ul>

<p>or</p>

<ul>
  <li>Include a namespace definition yaml file with the operator’s yaml definition files; for example, in the operator project’s <strong>./deploy</strong> directory.</li>
</ul>

<p>Note: When an operator is deployed into a non-default namespace, Open Horizon creates the namespace if it does not exist and removes it when the operator is undeployed by Open Horizon.</p>

<h2 id="packaging-an-operator-for-open-horizon">Packaging an operator for Open Horizon</h2>

<p>After an operator is written and tested, it needs to be packaged for deployment by Open Horizon:</p>

<ol>
  <li>
    <p>Ensure that the operator is packaged to run as a deployment inside a cluster. This means that the operator is built into a container and pushed to the container registry from which the container is retrieved when deployed by Open Horizon. Typically, this is accomplished by building the operator using the commands <strong>operator-sdk build</strong> followed by <strong>docker push</strong>. This is described in <a href="https://sdk.operatorframework.io/docs/building-operators/golang/tutorial/#2-run-as-a-deployment-inside-the-cluster">Operator Tutorial <img src="../images/icons/launch-glyph.svg" alt="Opens in a new tab" title="Opens in a new tab" /></a>.</p>
  </li>
  <li>
    <p>Ensure the service container or containers that are deployed by the operator are also pushed to the registry from which the operator will deploy them.</p>
  </li>
  <li>
    <p>Create an archive that contains the operator’s yaml definition files from the operator project:</p>

    <div class="language-bash codeblock highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;operator-project&gt;/&lt;operator-name&gt;/deploy
<span class="nb">tar</span> <span class="nt">-zcvf</span> &lt;archive-name&gt;.tar.gz ./<span class="k">*</span>
</code></pre></div>    </div>

    <p><strong>Note:</strong> For  users, consider creating a clean archive tar.gz file to ensure no hidden files exist in the tar.gz file. For example, a .DS_store file can cause problems when you deploy a helm operator. If you suspect that a hidden file exists, extract the tar.gz on your Linux system. For more information, see <a href="https://stackoverflow.com/questions/8766730/tar-command-in-mac-os-x-adding-hidden-files-why">Tar command in macos <img src="../images/icons/launch-glyph.svg" alt="Opens in a new tab" title="Opens in a new tab" /></a>.</p>

    <div class="language-bash codeblock highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">tar</span> <span class="nt">-xzpvf</span> x.tar <span class="nt">--exclude</span><span class="o">=</span><span class="s2">".*"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Use the Open Horizon service creation tools to create a service definition for the operator service, for example:</p>

    <ol>
      <li>
        <p>Create a new project:</p>

        <div class="language-bash codeblock highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hzn dev service new <span class="nt">-V</span> &lt;a version&gt; <span class="nt">-s</span> &lt;a service name&gt; <span class="nt">-c</span> cluster
</code></pre></div>        </div>
      </li>
      <li>
        <p>Edit the <strong>horizon/service.definition.json</strong> file to point to the operator’s yaml archive created previously in step 3.</p>
      </li>
      <li>
        <p>Create a service signing key, or use one you have already created.</p>
      </li>
      <li>
        <p>Publish the service</p>

        <div class="language-plaintext codeblock highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hzn exchange service publish -k &lt;signing key&gt; -f ./horizon/service.definition.json
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>
    <p>Create a deployment policy or pattern to deploy the operator service to an edge cluster.</p>
  </li>
</ol>

      </div>
	</div>
</div>

<hr>


	
    <!-- Footer -->
<footer>

    <div class="container">
        <div class="row">
             <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> 
                 <ul class="list-inline text-center">
                    <!-- <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li> -->
                    
                    
                    
                    <li>
                        <a href="https://github.com/open-horizon">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
					
                    <li>
                        <a href="https://github.com/open-horizon/open-horizon.github.io/issues">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-exclamation fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		         <li>
                        <a href="https://wiki.lfedge.org/display/OH/Open+Horizon">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-info fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <!-- <li>
                        <a href="https://github.com/projectpages/project-pages/fork">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-code-fork fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li> -->
                    
                </ul> 

                <div align="center">
                  <div class="copytext"><p><a href="https://app.slack.com/client/THT8G7R0V/C011XLC1V2Q" target="_blank" style="text-decoration:none">Join Chat</a>   |   <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" style="text-decoration:none">License</a>   |   ©2020 IBM. All rights reserved</p></div>

                </div>

        </div>
    </div>
</footer>


</body>

</html>
