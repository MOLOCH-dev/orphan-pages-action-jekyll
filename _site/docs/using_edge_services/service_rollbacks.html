<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="description" content="An Open Source Project for secure and robust containerized application management for constrained devices.">
	<meta property="og:title" content="Open Horizon" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://localhost:4000///docs/using_edge_services/service_rollbacks.html" />
<meta property="og:image" content="http://localhost:4000//img/hero-dark.jpg">

	

	<meta name="citation_title" content="Project Pages - An Integrated Scientific Blogging Template">



	

	<link rel='shortcut icon' type='image/png' href='/img/favicon.png' />

    <title>Open Horizon</title>

    <link rel="canonical" href="http://localhost:4000/docs/using_edge_services/service_rollbacks.html">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="http://localhost:4000/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="http://localhost:4000/css/clean-blog.css">

	<!-- Adjust Colors -->
    <link rel="stylesheet" href="http://localhost:4000/css/colorscheme.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="http://localhost:4000/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/css/normalize.css">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/cayman.css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
	<!-- Math Jax -->
	<script type="text/x-mathjax-config">
	MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
	</script>
	<script type="text/javascript"
	src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
	</script>
	<script type="text/x-mathjax-config">
	MathJax.Hub.Config({
		TeX: { equationNumbers: { autoNumber: "AMS" } }
	});
	</script>

	<!--<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js" type="text/javascript"></script>-->

    <!-- jQuery -->
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<!-- Custom Theme JavaScript -->
	<script src="http://localhost:4000/js/clean-blog.min.js "></script>

    <!-- Clipboard.js -->
    <script src="http://localhost:4000/js/clipboard.min.js " ></script>

    <!-- CDN Hosted Clipboard.js -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script> -->


	

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Open Horizon</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>

                <li>
                    <a href="/quick-start">Quick Start</a>
                </li>

                <li>
                    <a href="/docs/">Docs</a>
                </li>

                <!-- <li>
                    <a href="/blog">Blog</a>
                </li> -->

                <li>
                    <a href="/docs/getting_started/faq.html">FAQ</a>
                </li>


            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Page Header -->
<header class="intro-header" style="background-image: url('/img/hero-dark.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="site-heading" style="padding: 75px 0">
					
                    
                    

                    <h1 style="font-size:4.0em">Open Horizon</h1>
                    <hr class="small">

                    <span class="subheading">An Open Source Project for secure and robust containerized application management for constrained devices.</span>
                    

                </div>
            </div>
        </div>
    </div>
</header>

<div class="container">
	<div class="row">
      <div class="col-lg-12 col-md-12">
			
<h1 id="service_rollback">Updating an edge service with rollback</h1>

<p>Services on edge nodes are usually performing critical functions, so when a new version of an edge service is rolled out to many edge nodes, it is important to monitor the success of the deployment, and if it fails on any edge node, revert the node back to the previous version of the edge service. Open Horizon can do this automatically. In patterns or deployment policies, you can define which previous service version or versions should be used when a new service version fails.</p>

<p>The following content provides additional details on how to roll out a new version of an existing edge service and the software development best practices for updating rollback settings in pattern or deployment policies.</p>

<h2 id="creating_edge_service_definition">Creating a new edge service definition</h2>

<p>As explained in the <a href="/docs/developing/developing.html">Developing edge services with Open Horizon</a> and <a href="/docs/developing/developing_details.html">Development details</a> sections, the main steps to release a new version of an edge service are:</p>

<ul>
  <li>Edit the edge service code as needed for the new version.</li>
  <li>Edit the semantic version number of the code in the service version variable in the <strong>hzn.json</strong> configuration file.</li>
  <li>Rebuild your service containers.</li>
  <li>Sign and publish the new edge service version into the Horizon exchange.</li>
</ul>

<h2 id="updating_rollback_settings">Updating rollback settings in pattern or deployment policy</h2>

<p>A new edge service specifies its version number in the <code class="language-plaintext highlighter-rouge">version</code> field of the service definition.  </p>

<p>Patterns or deployment policies determine which services are deployed to which edge nodes. To use edge service rollback capabilities, you need to add the reference for your new service version number in the <strong>serviceVersions</strong> section in either the pattern or deployment policy configuration files.</p>

<p>When an edge service is deployed to an edge node as a result of a pattern or policy, the agent deploys the service version with the top priority value.</p>

<p>For example:</p>

<div class="language-json codeblock highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err"> </span><span class="nl">"serviceVersions"</span><span class="p">:</span><span class="err"> </span><span class="w">
</span><span class="p">[</span><span class="w">
</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="w"> </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.3.1"</span><span class="p">,</span><span class="w">
</span><span class="err">  </span><span class="w"> </span><span class="nl">"priority"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"priority_value"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"retries"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"retry_durations"</span><span class="p">:</span><span class="w"> </span><span class="mi">1800</span><span class="w">
</span><span class="err">  </span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="err"> </span><span class="p">},</span><span class="w">
</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="w"> </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
</span><span class="err">  </span><span class="w"> </span><span class="nl">"priority"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"priority_value"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"retries"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"retry_durations"</span><span class="p">:</span><span class="w"> </span><span class="mi">2400</span><span class="w">
</span><span class="err">  </span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">},</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="w"> </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.3.0"</span><span class="p">,</span><span class="w">
</span><span class="err">  </span><span class="w"> </span><span class="nl">"priority"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"priority_value"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"retries"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"retry_durations"</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="w">
</span><span class="err">  </span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Additional variables are provided in the priority section. The <code class="language-plaintext highlighter-rouge">priority_value</code> property sets the order of which service version to try first, in practical terms a lower number means higher priority. The <code class="language-plaintext highlighter-rouge">retries</code> variable value defines the number of times Horizon will attempt to start this service version within the time frame that is specified by <code class="language-plaintext highlighter-rouge">retry_durations</code> before rolling back to the next highest priority version. The <code class="language-plaintext highlighter-rouge">retry_durations</code> variable defines the specific time interval in seconds. For example, three service failures over the course of a month might not warrant rolling the service back to an earlier version, but 3 failures within 5 mins might be an indication that there is something wrong with the new service version.</p>

<p>Next, either republish your deployment pattern or update the deployment policy with the <strong>serviceVersion</strong> section changes in the Horizon exchange.</p>

<p>Notice that you can also verify the compatibility of the deployment policy or pattern settings updates with the CLI <code class="language-plaintext highlighter-rouge">deploycheck</code> command. To view more details, issue: </p>

<div class="language-bash codeblock highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hzn deploycheck <span class="nt">-h</span>
</code></pre></div></div>

<p>The Open Horizon agbots quickly detect the deployment pattern or deployment policy changes. The agbots then reach out to each agent whose edge node is either registered to run the deployment pattern or is compatible with the updated deployment policy. The agbot and the agent coordinate to download the new containers, stop and remove the old containers, and start the new containers.</p>

<p>As a result, your edge nodes that are either registered to run the updated deployment pattern or are compatible with the deployment policy quickly runs the new edge service version with the top priority value, regardless of where the edge node is geographically located.
 </p>

<h2 id="viewing_rollback_progress">Viewing progress of new service version being rolled out</h2>

<p>Repeatedly query the device agreements until the <code class="language-plaintext highlighter-rouge">agreement_finalized_time</code> and <code class="language-plaintext highlighter-rouge">agreement_execution_start_time</code> fields are filled in:</p>

<div class="language-bash codeblock highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hzn agreement list
</code></pre></div></div>

<p>Notice that the listed agreement shows the version that is associated with the service, and the date-time values appear in the variables (for example, “agreement_creation_time”: “”,)</p>

<p>Additionally, the version field is populated with the new (and operational) service version with the top priority value:</p>

<div class="language-json codeblock highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="err">…</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"agreement_creation_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-04-01 11:55:08 -0600 MDT"</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"agreement_accepted_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-04-01 11:55:17 -0600 MDT"</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"agreement_finalized_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-04-01 11:55:18 -0600 MDT"</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"agreement_execution_start_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-04-01 11:55:20 -0600 MDT"</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"agreement_data_received_time"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"agreement_protocol"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Basic"</span><span class="p">,</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="nl">"workload_to_run"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="err">     </span><span class="w"> </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ibm.helloworld"</span><span class="p">,</span><span class="w">
</span><span class="err">     </span><span class="w"> </span><span class="nl">"org"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ibm"</span><span class="p">,</span><span class="w">
</span><span class="err">     </span><span class="w"> </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.3.1"</span><span class="p">,</span><span class="w">
</span><span class="err">     </span><span class="w"> </span><span class="nl">"arch"</span><span class="p">:</span><span class="w"> </span><span class="s2">"amd64"</span><span class="w">
</span><span class="err">   </span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>For additional details, you can inspect the event logs for the current node with the CLI command:</p>

<div class="language-bash codeblock highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hzn eventlog list
</code></pre></div></div>

<p>Lastly, you can also use the <a href="../console/accessing_ui.md">management console</a> to modify rollback deployment versions settings. You can do this when creating a new deployment policy or by viewing and editing existing policy details including rollbacks settings. Note the term “time frame” in the rollback section of the UI is equivalent to “retry_durations” in the CLI.</p>

      </div>
	</div>
</div>

<hr>


	
    <!-- Footer -->
<footer>

    <div class="container">
        <div class="row">
             <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"> 
                 <ul class="list-inline text-center">
                    <!-- <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li> -->
                    
                    
                    
                    <li>
                        <a href="https://github.com/open-horizon">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
					
                    <li>
                        <a href="https://github.com/open-horizon/open-horizon.github.io/issues">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-exclamation fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		         <li>
                        <a href="https://wiki.lfedge.org/display/OH/Open+Horizon">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-info fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <!-- <li>
                        <a href="https://github.com/projectpages/project-pages/fork">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-code-fork fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li> -->
                    
                </ul> 

                <div align="center">
                  <div class="copytext"><p><a href="https://app.slack.com/client/THT8G7R0V/C011XLC1V2Q" target="_blank" style="text-decoration:none">Join Chat</a>   |   <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" style="text-decoration:none">License</a>   |   ©2020 IBM. All rights reserved</p></div>

                </div>

        </div>
    </div>
</footer>


</body>

</html>
